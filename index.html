<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mesa Tracker">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <title>Mesa Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0a0a0f;--bg2:#16161f;--border:#252530;--text:#fff;--muted:#606070;--green:#00ff88;--red:#ff4466;--blue:#4488ff;--yellow:#ffcc00}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .app{max-width:1600px;margin:0 auto;padding:12px}
        .header{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--bg2);border-radius:16px;border:1px solid var(--border);margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:44px;height:44px;background:linear-gradient(135deg,var(--green),#00cc6a);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
        .logo h1{font-size:1.3rem;background:linear-gradient(135deg,var(--green),#00cc6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .logo span{font-size:.8rem;color:var(--muted)}
        .header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .cloud-btns{display:flex;gap:6px}
        .cloud-btn{width:40px;height:40px;border-radius:10px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.3s}
        .cloud-btn.backup{background:#1a1a2e;border:1px solid #2a2a3e}
        .cloud-btn.restore{background:var(--blue)}
        .cloud-btn:hover{transform:scale(1.05)}
        .cloud-btn svg{width:20px;height:20px;fill:#666}
        .cloud-btn.restore svg{fill:#fff}
        .cloud-btn .spin{display:none;width:16px;height:16px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 1s linear infinite}
        .cloud-btn.loading svg{display:none}
        .cloud-btn.loading .spin{display:block}
        @keyframes spin{to{transform:rotate(360deg)}}
        .badge{padding:6px 14px;border-radius:50px;font-size:.75rem;font-weight:600;text-transform:uppercase}
        .badge.plan{background:linear-gradient(135deg,var(--green),#00cc6a);color:#000}
        .badge.test{background:rgba(255,204,0,.2);color:var(--yellow);border:1px solid var(--yellow)}
        .badge.normal{background:rgba(0,255,136,.2);color:var(--green);border:1px solid var(--green)}
        .tabs{display:flex;gap:6px;background:var(--bg2);padding:8px;border-radius:12px;border:1px solid var(--border);margin-bottom:16px;overflow-x:auto}
        .tab{padding:10px 16px;background:0;border:0;color:var(--muted);font-family:inherit;font-size:.9rem;font-weight:500;cursor:pointer;border-radius:8px;white-space:nowrap}
        .tab:hover{background:#1a1a25;color:var(--text)}
        .tab.active{background:var(--green);color:#000;font-weight:600}
        .content{display:none}
        .content.active{display:block;animation:fadeIn .3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-bottom:16px}
        .card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px}
        .card.green{border-color:var(--green);box-shadow:0 0 30px rgba(0,255,136,.2)}
        .card-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
        .card-label{font-size:.8rem;color:var(--muted);text-transform:uppercase}
        .card-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
        .card-icon.g{background:rgba(0,255,136,.15)}
        .card-icon.r{background:rgba(255,68,102,.15)}
        .card-icon.b{background:rgba(68,136,255,.15)}
        .card-icon.y{background:rgba(255,204,0,.15)}
        .val{font-family:'JetBrains Mono',monospace;font-size:1.7rem;font-weight:700;margin-bottom:6px}
        .val.g{color:var(--green)}.val.r{color:var(--red)}.val.b{color:var(--blue)}.val.y{color:var(--yellow)}
        .sub{font-size:.8rem;color:var(--muted)}
        .progress-section{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
        .prog-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
        .prog-title{font-size:1.1rem;font-weight:600}
        .prog-pct{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:700;color:var(--green)}
        .prog-bar{background:var(--bg);border-radius:12px;height:20px;overflow:hidden;margin-bottom:10px}
        .prog-fill{height:100%;background:linear-gradient(135deg,var(--green),#00cc6a);border-radius:12px;transition:.5s;position:relative}
        .prog-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);animation:shimmer 2s infinite}
        @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
        .prog-marks{display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--muted)}
        .days-prog{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
        .days-prog .prog-bar{height:16px;background:rgba(68,136,255,.2)}
        .days-prog .prog-fill{background:linear-gradient(135deg,var(--blue),#3366cc)}
        .days-prog .prog-pct{color:var(--blue)}
        .days-info{display:flex;justify-content:space-between;margin-top:8px;font-size:.85rem;flex-wrap:wrap;gap:8px}
        .days-info span{color:var(--muted)}
        .days-info strong{color:var(--blue);font-family:'JetBrains Mono',monospace}
        .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
        @media(max-width:900px){.two-col{grid-template-columns:1fr}}
        .title{font-size:1rem;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:10px}
        .form-group{margin-bottom:14px}
        .label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:6px}
        .input,.select{width:100%;padding:11px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.9rem}
        .input:focus,.select:focus{outline:0;border-color:var(--green)}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
        .btn{padding:11px 20px;border:0;border-radius:10px;font-family:inherit;font-size:.9rem;font-weight:600;cursor:pointer;transition:.3s;display:inline-flex;align-items:center;justify-content:center;gap:8px}
        .btn-p{background:linear-gradient(135deg,var(--green),#00cc6a);color:#000}
        .btn-p:hover{transform:translateY(-2px);box-shadow:0 0 30px rgba(0,255,136,.2)}
        .btn-s{background:var(--bg);color:var(--text);border:1px solid var(--border)}
        .btn-d{background:var(--red);color:#fff}
        .btn-b{background:linear-gradient(135deg,var(--blue),#3366cc);color:#fff}
        .btn-y{background:var(--yellow);color:#000}
        .action-row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
        .table-wrap{overflow-x:auto;margin-top:14px}
        table{width:100%;border-collapse:collapse;min-width:500px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
        th{font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;background:var(--bg)}
        td{font-family:'JetBrains Mono',monospace;font-size:.85rem}
        tr:hover{background:#1a1a25}
        .pos{color:var(--green)}.neg{color:var(--red)}
        .mini-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
        .mini{background:var(--bg);border-radius:12px;padding:14px;text-align:center}
        .mini-val{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;margin-bottom:4px}
        .mini-label{font-size:.7rem;color:var(--muted);text-transform:uppercase}
        .result{background:var(--bg);border-radius:12px;padding:16px;margin-top:14px}
        .result-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
        .result-item:last-child{border-bottom:0}
        .day-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:14px}
        .day-card{background:var(--bg);border-radius:12px;padding:14px 8px;text-align:center;border:2px solid transparent}
        .day-card.best{border-color:var(--green);background:rgba(0,255,136,.05)}
        .day-card.worst{border-color:var(--red);background:rgba(255,68,102,.05)}
        .day-name{font-weight:600;margin-bottom:6px;font-size:.9rem}
        .day-result{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700}
        .day-trades{font-size:.75rem;color:var(--muted);margin-top:4px}
        .settings-section{margin-bottom:20px}
        .settings-title{font-size:.95rem;font-weight:600;color:var(--muted);margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border)}
        .mode-toggle{display:flex;background:var(--bg);border-radius:10px;padding:4px;gap:4px}
        .mode-btn{padding:10px 20px;border:0;border-radius:8px;background:0;color:var(--muted);font-family:inherit;font-size:.9rem;cursor:pointer}
        .mode-btn.active{background:var(--green);color:#000;font-weight:600}
        .mode-btn.test-active{background:var(--yellow);color:#000}
        .test-section{display:none;margin-top:14px;padding:14px;background:rgba(255,204,0,.1);border:1px solid var(--yellow);border-radius:10px}
        .test-section.visible{display:block}
        .gist-config{background:var(--bg);border-radius:12px;padding:16px;margin-top:14px}
        .gist-status{display:flex;align-items:center;gap:8px;font-size:.85rem;margin-top:10px;color:var(--muted)}
        .gist-status.connected{color:var(--green)}
        .alert{padding:14px 18px;border-radius:12px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:.9rem}
        .alert-success{background:rgba(0,255,136,.1);border:1px solid var(--green);color:var(--green)}
        .alert-warning{background:rgba(255,204,0,.1);border:1px solid var(--yellow);color:var(--yellow)}
        .alert-danger{background:rgba(255,68,102,.1);border:1px solid var(--red);color:var(--red)}
        .projection{background:linear-gradient(135deg,rgba(0,255,136,.1),rgba(68,136,255,.1));border:1px solid var(--green);border-radius:16px;padding:20px;margin-bottom:16px}
        .proj-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-top:14px}
        .proj-item{text-align:center}
        .proj-val{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;color:var(--green)}
        .proj-label{font-size:.8rem;color:var(--muted);margin-top:4px}
        .toast{position:fixed;bottom:20px;right:20px;padding:14px 20px;border-radius:12px;background:var(--bg2);border:1px solid var(--border);font-size:.9rem;z-index:1000;transform:translateY(100px);opacity:0;transition:.3s;max-width:90vw}
        .toast.show{transform:translateY(0);opacity:1}
        .toast.success{border-color:var(--green);background:rgba(0,255,136,.1)}
        .toast.error{border-color:var(--red);background:rgba(255,68,102,.1)}
        .empty{text-align:center;padding:40px 20px;color:var(--muted)}
        .btn-del{background:0;border:0;color:var(--red);cursor:pointer;padding:4px 8px;border-radius:4px}
        .btn-del:hover{background:rgba(255,68,102,.2)}
        .plan-rule{background:var(--bg);border-radius:12px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;border-left:4px solid var(--green)}
        .plan-rule.warning{border-left-color:var(--yellow)}
        .plan-rule.danger{border-left-color:var(--red)}
        .rule-num{width:28px;height:28px;background:var(--green);color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0}
        .plan-rule.warning .rule-num{background:var(--yellow)}
        .plan-rule.danger .rule-num{background:var(--red);color:#fff}
        .rule-text{flex:1;font-size:.9rem}
        .import-section{background:var(--bg);border-radius:12px;padding:16px;margin-bottom:16px;border:2px dashed var(--border)}
        .import-section:hover{border-color:var(--green)}
        .file-input{display:none}
        .import-label{display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;padding:20px}
        .import-icon{font-size:2.5rem}
        .import-text{color:var(--muted);font-size:.9rem;text-align:center}
        .divider{display:flex;align-items:center;gap:16px;margin:20px 0;color:var(--muted);font-size:.85rem}
        .divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
        @media(max-width:768px){.header{padding:12px}.logo h1{font-size:1.1rem}.row,.row3{grid-template-columns:1fr}.day-grid{grid-template-columns:repeat(3,1fr)}.val{font-size:1.4rem}.tab{padding:8px 12px;font-size:.8rem}.card{padding:16px}.proj-val{font-size:1.2rem}.cloud-btn{width:36px;height:36px}}
        @media(max-width:480px){.app{padding:8px}.day-grid{grid-template-columns:repeat(2,1fr)}.mini-grid{grid-template-columns:repeat(2,1fr)}.proj-grid{grid-template-columns:repeat(2,1fr)}.logo-icon{width:36px;height:36px;font-size:18px}}
        .manual-section{margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)}
        .manual-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
        .manual-item{background:var(--bg);padding:12px 14px;border-radius:8px;margin-bottom:8px;font-size:.9rem;line-height:1.5}
        .manual-item strong{color:var(--green)}
        .btn-edit{background:0;border:0;color:var(--blue);cursor:pointer;padding:4px 8px;border-radius:4px;margin-right:4px}
        .btn-edit:hover{background:rgba(68,136,255,.2)}
        .custom-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
        .custom-item{background:var(--bg);padding:6px 12px;border-radius:8px;display:flex;align-items:center;gap:8px;font-size:.85rem}
        .custom-item button{background:0;border:0;color:var(--red);cursor:pointer;font-size:.8rem;padding:2px}
        .imposto-pago{color:var(--green) !important}
        .imposto-pendente{color:var(--yellow) !important}
        .license-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px}
        .license-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:40px;max-width:450px;width:100%;text-align:center}
        .license-logo{font-size:4rem;margin-bottom:20px}
        .license-title{font-size:1.5rem;font-weight:700;margin-bottom:8px;background:linear-gradient(135deg,var(--green),#00cc6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .license-subtitle{color:var(--muted);margin-bottom:30px;font-size:.9rem}
        .license-error{background:rgba(255,68,102,.1);border:1px solid var(--red);color:var(--red);padding:12px;border-radius:10px;margin-bottom:16px;font-size:.85rem;display:none}
        .license-success{background:rgba(0,255,136,.1);border:1px solid var(--green);color:var(--green);padding:12px;border-radius:10px;margin-bottom:16px;font-size:.85rem;display:none}
        .license-info{margin-top:20px;padding-top:20px;border-top:1px solid var(--border);font-size:.8rem;color:var(--muted)}
        .auth-tabs{display:flex;margin-bottom:20px;background:var(--bg);border-radius:10px;padding:4px}
        .auth-tab{flex:1;padding:10px;border:none;background:none;color:var(--muted);cursor:pointer;border-radius:8px;font-family:inherit;font-weight:500;transition:.3s}
        .auth-tab.active{background:var(--green);color:#000;font-weight:600}
        .auth-tab:hover:not(.active){background:rgba(255,255,255,.05)}
    </style>
</head>
<body>
<!-- TELA DE LOGIN/REGISTRO -->
<div id="authOverlay" class="license-overlay">
    <div class="license-box">
        <div class="license-logo">üìä</div>
        <h1 class="license-title">Mesa Tracker</h1>
        <p class="license-subtitle">Gest√£o de Mesa Propriet√°ria</p>
        
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="showAuthTab('login')">Entrar</button>
            <button class="auth-tab" onclick="showAuthTab('register')">Criar Conta</button>
        </div>
        
        <div id="loginForm">
            <div id="authError" class="license-error"></div>
            <div id="authSuccess" class="license-success"></div>
            <div class="license-form">
                <div class="form-group"><label class="label">Email</label><input type="email" id="authEmail" class="input" placeholder="seu@email.com"></div>
                <div class="form-group"><label class="label">Senha</label><input type="password" id="authPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button class="btn btn-p" onclick="doLogin()" style="width:100%;margin-top:10px" id="authBtn">üîì Entrar</button>
            </div>
        </div>
        
        <div id="registerForm" style="display:none">
            <div id="regError" class="license-error"></div>
            <div id="regSuccess" class="license-success"></div>
            <div class="license-form">
                <div class="form-group"><label class="label">Nome</label><input type="text" id="regName" class="input" placeholder="Seu nome"></div>
                <div class="form-group"><label class="label">Email</label><input type="email" id="regEmail" class="input" placeholder="seu@email.com"></div>
                <div class="form-group"><label class="label">Senha</label><input type="password" id="regPassword" class="input" placeholder="M√≠nimo 6 caracteres"></div>
                <button class="btn btn-p" onclick="doRegister()" style="width:100%;margin-top:10px" id="regBtn">‚ú® Criar Conta</button>
            </div>
        </div>
        
        <div id="activateForm" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
            <p style="color:var(--muted);font-size:.85rem;margin-bottom:12px">Ative sua licen√ßa para continuar</p>
            <div class="form-group"><input type="text" id="licenseCode" class="input" placeholder="MESA-XXXX-XXXX" style="text-transform:uppercase;text-align:center"></div>
            <button class="btn btn-b" onclick="activateLicense()" style="width:100%">üîë Ativar C√≥digo</button>
        </div>
        
        <div class="license-info"><p>N√£o tem licen√ßa? Entre em contato:</p><p style="color:var(--green);margin-top:5px">üì± (XX) XXXXX-XXXX</p></div>
    </div>
</div>

<div class="app" id="mainApp" style="display:none">
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üìä</div>
            <div><h1>Mesa Tracker</h1><span>LTX Capital - 44962</span></div>
        </div>
        <div class="header-right">
            <div class="cloud-btns">
                <button class="cloud-btn backup" onclick="saveToCloud(true)" title="Salvar na Nuvem">
                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                    <div class="spin"></div>
                </button>
                <button class="cloud-btn restore" onclick="loadFromCloud()" title="Carregar da Nuvem">
                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
                    <div class="spin"></div>
                </button>
            </div>
            <span id="modeBadge" class="badge normal">Normal</span>
            <div class="badge plan">üèÜ <span id="planBadge">STARTER</span></div>
        </div>
    </header>

    <nav class="tabs">
        <button class="tab active" data-tab="dashboard">üìà Dashboard</button>
        <button class="tab" data-tab="trades">üìù Registrar</button>
        <button class="tab" data-tab="history">üìã Hist√≥rico</button>
        <button class="tab" data-tab="analysis">üîç An√°lise</button>
        <button class="tab" data-tab="calculator">üßÆ Calculadora</button>
        <button class="tab" data-tab="plan">üìå Plano</button>
        <button class="tab" data-tab="settings">‚öôÔ∏è Config</button>
        <button class="tab" data-tab="imposto">üí∞ Imposto</button>
        <button class="tab" data-tab="manual">üìñ Manual</button>
    </nav>

    <div id="dashboard" class="content active">
        <div id="statusAlert" class="alert alert-success"><span>‚úÖ</span><span id="alertText">Continue focado!</span></div>
        <div id="impostoPendenteAlert" class="alert alert-danger" style="display:none"><span>‚ö†Ô∏è</span><span>IMPOSTO EM ATRASO: <strong id="impostoPendenteValor">R$ 0,00</strong> - Pague o DARF para evitar multas!</span></div>
        <div class="progress-section">
            <div class="prog-head"><h2 class="prog-title">üéØ Progresso da Meta</h2><span id="progPct" class="prog-pct">0%</span></div>
            <div class="prog-bar"><div id="progBar" class="prog-fill" style="width:0%"></div></div>
            <div class="prog-marks"><span>R$ 0</span><span id="progCurrent">R$ 0</span><span id="progMeta">R$ 2.200</span></div>
            <div class="days-prog">
                <div class="prog-head"><h3 class="prog-title" style="font-size:1rem">üìÖ Tempo Restante</h3><span id="daysPct" class="prog-pct">0%</span></div>
                <div class="prog-bar"><div id="daysBar" class="prog-fill" style="width:0%"></div></div>
                <div class="days-info"><span>Passados: <strong id="daysPassed">0</strong></span><span>Faltam: <strong id="daysLeft">0</strong></span><span>Total: <strong id="daysTotal">0</strong></span></div>
            </div>
        </div>
        <div class="grid">
            <div class="card green"><div class="card-head"><span class="card-label">Saldo Atual</span><div class="card-icon g">üí∞</div></div><div id="saldo" class="val g">R$ 0</div><div class="sub">Lucro acumulado</div></div>
            <div class="card"><div class="card-head"><span class="card-label">Falta p/ Meta</span><div class="card-icon b">üéØ</div></div><div id="falta" class="val b">R$ 0</div><div class="sub">Continue!</div></div>
            <div class="card"><div class="card-head"><span class="card-label">Margem Perda</span><div class="card-icon y">‚ö†Ô∏è</div></div><div id="margem" class="val y">R$ 0</div><div class="sub">Dispon√≠vel</div></div>
            <div class="card"><div class="card-head"><span class="card-label">Taxa Acerto</span><div class="card-icon g">üìä</div></div><div id="winrate" class="val g">0%</div><div class="sub">Vencedoras</div></div>
            <div class="card"><div class="card-head"><span class="card-label">Total Ops</span><div class="card-icon b">üìà</div></div><div id="totalOps" class="val b">0</div><div class="sub">Trades</div></div>
            <div class="card"><div class="card-head"><span class="card-label">Fator Lucro</span><div class="card-icon g">‚ö°</div></div><div id="pf" class="val g">0</div><div class="sub">Lucro/Perda</div></div>
            <div class="card" id="impostoCard"><div class="card-head"><span class="card-label">Imposto do M√™s</span><div class="card-icon r">üí∏</div></div><div id="impostoDash" class="val r">R$ 0,00</div><div class="sub">DARF a pagar</div></div>
        </div>
        <div class="projection">
            <h3>üöÄ Proje√ß√£o</h3><p style="color:var(--muted);font-size:.85rem">Baseado na performance</p>
            <div class="proj-grid">
                <div class="proj-item"><div id="projDias" class="proj-val">-</div><div class="proj-label">Dias estimados</div></div>
                <div class="proj-item"><div id="projMedia" class="proj-val">-</div><div class="proj-label">M√©dia/dia</div></div>
                <div class="proj-item"><div id="projOps" class="proj-val">-</div><div class="proj-label">Ops necess√°rias</div></div>
                <div class="proj-item"><div id="projLucro" class="proj-val">-</div><div class="proj-label">Lucro aprova√ß√£o</div></div>
            </div>
        </div>
        <div class="two-col">
            <div class="card"><h3 class="title"><span>üí∞</span> Financeiro</h3>
                <div class="mini-grid">
                    <div class="mini"><div id="lucroBruto" class="mini-val g">R$ 0</div><div class="mini-label">Lucro Bruto</div></div>
                    <div class="mini"><div id="prejBruto" class="mini-val r">R$ 0</div><div class="mini-label">Preju√≠zo Bruto</div></div>
                    <div class="mini"><div id="mediaGain" class="mini-val g">R$ 0</div><div class="mini-label">M√©dia Gain</div></div>
                    <div class="mini"><div id="mediaLoss" class="mini-val r">R$ 0</div><div class="mini-label">M√©dia Loss</div></div>
                    <div class="mini"><div id="maiorGain" class="mini-val g">R$ 0</div><div class="mini-label">Maior Gain</div></div>
                    <div class="mini"><div id="maiorLoss" class="mini-val r">R$ 0</div><div class="mini-label">Maior Loss</div></div>
                </div>
            </div>
            <div class="card"><h3 class="title"><span>üìä</span> Opera√ß√µes</h3>
                <div class="mini-grid">
                    <div class="mini"><div id="wins" class="mini-val g">0</div><div class="mini-label">Vencedoras</div></div>
                    <div class="mini"><div id="losses" class="mini-val r">0</div><div class="mini-label">Perdedoras</div></div>
                    <div class="mini"><div id="zeros" class="mini-val">0</div><div class="mini-label">Zeradas</div></div>
                    <div class="mini"><div id="rr" class="mini-val b">0</div><div class="mini-label">Raz√£o R:R</div></div>
                    <div class="mini"><div id="seqW" class="mini-val g">0</div><div class="mini-label">Seq Win</div></div>
                    <div class="mini"><div id="seqL" class="mini-val r">0</div><div class="mini-label">Seq Loss</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="trades" class="content">
        <div class="card">
            <h3 class="title"><span>üì§</span> Importar CSV da Mesa</h3>
            <div class="import-section">
                <label class="import-label">
                    <input type="file" class="file-input" id="csvFile" accept=".csv" onchange="importCSV(event)">
                    <div class="import-icon">üìÅ</div>
                    <div class="import-text">Clique ou arraste o arquivo CSV<br><small>Apenas opera√ß√µes novas ser√£o adicionadas</small></div>
                </label>
            </div>
            <div id="importResult" style="display:none;margin-top:10px"></div>
            
            <div class="divider">ou registre manualmente</div>
            
            <h3 class="title"><span>üìù</span> Registro Manual</h3>
            <div class="row"><div class="form-group"><label class="label">Data</label><input type="date" id="tDate" class="input"></div><div class="form-group"><label class="label">Hora</label><input type="time" id="tTime" class="input"></div></div>
            <div class="row3"><div class="form-group"><label class="label">Ativo</label><select id="tAsset" class="select"><option>WIN</option><option>WDO</option><option>IND</option><option>DOL</option></select></div><div class="form-group"><label class="label">Dire√ß√£o</label><select id="tDir" class="select"><option value="C">Compra</option><option value="V">Venda</option></select></div><div class="form-group"><label class="label">Contratos</label><input type="number" id="tCts" class="input" min="1" max="250" value="1"></div></div>
            <div class="row3"><div class="form-group"><label class="label">Entrada</label><input type="number" id="tEntry" class="input" step="0.5" placeholder="pts"></div><div class="form-group"><label class="label">Sa√≠da</label><input type="number" id="tExit" class="input" step="0.5" placeholder="pts"></div><div class="form-group"><label class="label">Resultado R$</label><input type="number" id="tResult" class="input" step="0.01" placeholder="50 ou -30"></div></div>
            <div class="form-group"><label class="label">Setup</label><select id="tSetup" class="select"><option value="">Selecione...</option></select></div>
            <div class="form-group"><label class="label">Qualidade</label><select id="tQual" class="select"></select></div>
            <div class="action-row">
                <button class="btn btn-p" onclick="addTrade()">üíæ Salvar</button>
                <button class="btn btn-s" onclick="clearForm()">üîÑ Limpar</button>
                <button class="btn btn-d" onclick="clearAllTrades()">üóëÔ∏è Limpar Todos Registros</button>
            </div>
        </div>
    </div>

    <div id="history" class="content">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
                <h3 class="title" style="margin:0"><span>üìã</span> Hist√≥rico (<span id="histCount">0</span>)</h3>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn btn-s" onclick="exportCSV()">üì§ CSV</button>
                    <button class="btn btn-d" onclick="clearAllTrades()">üóëÔ∏è Limpar</button>
                </div>
            </div>
            <div id="historyTable" class="table-wrap"><div class="empty">üì≠ Nenhuma opera√ß√£o</div></div>
        </div>
    </div>

    <div id="analysis" class="content">
        <div class="two-col">
            <div class="card"><h3 class="title"><span>üìÖ</span> Por Dia</h3><div id="dayAnalysis" class="day-grid"></div></div>
            <div class="card"><h3 class="title"><span>üéØ</span> Por Setup</h3><div id="setupAnalysis"><div class="empty">Registre opera√ß√µes</div></div></div>
        </div>
    </div>

    <div id="calculator" class="content">
        <div class="two-col">
            <div class="card">
                <h3 class="title"><span>üßÆ</span> Gest√£o de Risco</h3>
                <div class="form-group"><label class="label">Margem risco R$</label><input type="number" id="calcCap" class="input" placeholder="500"></div>
                <div class="form-group"><label class="label">Risco %</label><input type="number" id="calcRisk" class="input" value="2"></div>
                <div class="form-group"><label class="label">Stop (pts)</label><input type="number" id="calcStop" class="input" placeholder="100"></div>
                <div class="form-group"><label class="label">Valor ponto</label><select id="calcPt" class="select"><option value="0.2">WIN - R$0,20</option><option value="10">WDO - R$10</option><option value="1">IND - R$1</option><option value="50">DOL - R$50</option></select></div>
                <div class="form-group"><label class="label">Raz√£o R:R (Gain)</label><select id="calcRR" class="select"><option value="1.5">1.5:1</option><option value="2" selected>2:1</option><option value="2.5">2.5:1</option><option value="3">3:1</option><option value="3.5">3.5:1</option><option value="4">4:1</option><option value="5">5:1</option></select></div>
                <button class="btn btn-p" onclick="calcRisk()" style="width:100%">‚ö° Calcular</button>
                <div id="riskResult" class="result" style="display:none"></div>
            </div>
            <div class="card">
                <h3 class="title"><span>üéØ</span> Simulador Meta</h3>
                <div class="form-group"><label class="label">Falta p/ meta R$</label><input type="number" id="simFalta" class="input"></div>
                <div class="form-group"><label class="label">M√©dia gain R$</label><input type="number" id="simGain" class="input" placeholder="50"></div>
                <div class="form-group"><label class="label">M√©dia loss R$</label><input type="number" id="simLoss" class="input" placeholder="50"></div>
                <div class="form-group"><label class="label">Ops/dia</label><input type="number" id="simOps" class="input" value="3"></div>
                <div class="form-group"><label class="label">Taxa acerto %</label><input type="number" id="simWR" class="input" value="50"></div>
                <div class="form-group"><label class="label">Dias oper√°veis restantes</label><input type="number" id="simDays" class="input" placeholder="20"></div>
                <button class="btn btn-p" onclick="simMeta()" style="width:100%">üöÄ Simular</button>
                <div id="simResult" class="result" style="display:none"></div>
            </div>
        </div>
    </div>

    <div id="plan" class="content">
        <div class="card" style="margin-bottom:16px;text-align:center">
            <div style="font-size:2rem">üèÜ</div>
            <div style="font-size:1.1rem;font-weight:600">Passar no Starter</div>
            <div style="color:var(--muted)">Meta: R$2.200 | Limite: R$2.500 | 6 Cts</div>
        </div>
        <div class="two-col">
            <div class="card"><h3 class="title"><span>üìã</span> Regras</h3>
                <div class="plan-rule"><div class="rule-num">1</div><div class="rule-text"><strong>M√°x 6 contratos</strong></div></div>
                <div class="plan-rule"><div class="rule-num">2</div><div class="rule-text"><strong>Stop SEMPRE</strong> 100-150pts</div></div>
                <div class="plan-rule"><div class="rule-num">3</div><div class="rule-text"><strong>Risco di√°rio</strong> R$200-300</div></div>
                <div class="plan-rule warning"><div class="rule-num">4</div><div class="rule-text"><strong>3 loss = PARE</strong></div></div>
                <div class="plan-rule warning"><div class="rule-num">5</div><div class="rule-text"><strong>Sem revenge</strong></div></div>
                <div class="plan-rule danger"><div class="rule-num">6</div><div class="rule-text"><strong>NUNCA aumente perdedor</strong></div></div>
            </div>
            <div class="card"><h3 class="title"><span>‚è∞</span> Rotina</h3>
                <div class="plan-rule"><div class="rule-num">1</div><div class="rule-text"><strong>08:30</strong> An√°lise</div></div>
                <div class="plan-rule"><div class="rule-num">2</div><div class="rule-text"><strong>09:00-09:30</strong> Observar</div></div>
                <div class="plan-rule"><div class="rule-num">3</div><div class="rule-text"><strong>09:30-12:00</strong> Operar</div></div>
                <div class="plan-rule"><div class="rule-num">4</div><div class="rule-text"><strong>12:00-14:00</strong> Evitar</div></div>
                <div class="plan-rule"><div class="rule-num">5</div><div class="rule-text"><strong>14:00-16:00</strong> Operar</div></div>
                <div class="plan-rule warning"><div class="rule-num">6</div><div class="rule-text"><strong>Meta = PARE</strong></div></div>
            </div>
        </div>
    </div>

    <div id="settings" class="content">
        <div class="two-col">
            <div class="card">
                <h3 class="title"><span>‚öôÔ∏è</span> Configura√ß√µes</h3>
                <div class="settings-section">
                    <div class="settings-title">Modo</div>
                    <div class="mode-toggle">
                        <button class="mode-btn active" id="modeN" onclick="setMode('normal')">Normal</button>
                        <button class="mode-btn" id="modeT" onclick="setMode('test')">Teste</button>
                    </div>
                    <div id="testSection" class="test-section">
                        <p style="font-size:.85rem;color:var(--yellow);margin-bottom:10px">‚ö†Ô∏è Per√≠odo de 2 meses</p>
                        <div class="form-group" style="margin:0"><label class="label">Data in√≠cio teste</label><input type="date" id="sTestDate" class="input"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Plano</div>
                    <select id="sPlan" class="select" onchange="updatePlan()"><option value="starter">Starter</option><option value="pro">PRO</option><option value="master">Master</option><option value="black">Black</option><option value="platinum">Platinum</option></select>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Metas</div>
                    <div class="row"><div class="form-group"><label class="label">Meta R$</label><input type="number" id="sMeta" class="input" value="2200"></div><div class="form-group"><label class="label">Limite R$</label><input type="number" id="sLimite" class="input" value="2500"></div></div>
                    <div class="row"><div class="form-group"><label class="label">M√°x Cts</label><input type="number" id="sCts" class="input" value="6"></div><div class="form-group"><label class="label">Repasse %</label><input type="number" id="sRepasse" class="input" value="80"></div></div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Saldo/Data</div>
                    <div class="row"><div class="form-group"><label class="label">Saldo Inicial</label><input type="number" id="sSaldo" class="input" value="0" step="0.01"></div><div class="form-group"><label class="label">Data In√≠cio</label><input type="date" id="sData" class="input"></div></div>
                </div>
                <button class="btn btn-p" onclick="saveSettings()" style="width:100%">üíæ Salvar</button>
                
                <div class="settings-section" style="margin-top:16px">
                    <div class="settings-title">üéØ Setups Personalizados</div>
                    <div id="setupList" class="custom-list"></div>
                    <div class="row" style="margin-top:10px">
                        <input type="text" id="newSetup" class="input" placeholder="Nome do setup">
                        <button class="btn btn-p" onclick="addSetup()">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="settings-section" style="margin-top:16px">
                    <div class="settings-title">üìä Qualidades Personalizadas</div>
                    <div id="qualList" class="custom-list"></div>
                    <div class="row" style="margin-top:10px">
                        <input type="text" id="newQual" class="input" placeholder="Nome da qualidade">
                        <button class="btn btn-p" onclick="addQual()">+ Adicionar</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3 class="title"><span>üíæ</span> Backup</h3>
                <div class="settings-section">
                    <div class="settings-title">Local</div>
                    <div class="action-row"><button class="btn btn-s" onclick="backupLocal()" style="flex:1">üì• Backup</button><button class="btn btn-s" onclick="document.getElementById('impFile').click()" style="flex:1">üì§ Restaurar</button><input type="file" id="impFile" accept=".json" style="display:none" onchange="restoreLocal(event)"></div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Nuvem (Gist)</div>
                    <div class="gist-config">
                        <div class="form-group"><label class="label">Token</label><input type="password" id="gToken" class="input" placeholder="ghp_xxx"></div>
                        <div class="form-group"><label class="label">Gist ID</label><input type="text" id="gId" class="input" placeholder="vazio=criar"></div>
                        <button class="btn btn-s" onclick="saveGist()" style="width:100%;margin-top:10px">üíæ Salvar Config</button>
                        <div id="gStatus" class="gist-status">‚ö™ N√£o configurado</div>
                    </div>
                    <div class="action-row" style="margin-top:14px"><button class="btn btn-b" onclick="backupGist()" style="flex:1">‚òÅÔ∏è Backup</button><button class="btn btn-b" onclick="restoreGist()" style="flex:1">‚¨áÔ∏è Restaurar</button></div>
                </div>
                <div class="settings-section"><div class="settings-title">‚ö†Ô∏è Perigo</div><button class="btn btn-d" onclick="clearAll()">üóëÔ∏è Limpar Tudo</button></div>
                <div class="settings-section"><div class="settings-title">üö™ Conta</div><button class="btn btn-s" onclick="doLogout()" style="width:100%">üö™ Sair da Conta</button></div>
            </div>
        </div>
    </div>

    <div id="imposto" class="content">
        <div class="card" style="margin-bottom:16px">
            <h2 class="title" style="font-size:1.3rem"><span>üí∞</span> Controle de Impostos - Day Trade</h2>
            <p style="color:var(--muted)">Al√≠quota: 20% sobre lucro l√≠quido mensal (Day Trade)</p>
        </div>

        <div class="grid" style="margin-bottom:16px">
            <div class="card green">
                <div class="card-head"><span class="card-label">Imposto Devido M√™s Atual</span><div class="card-icon r">üí∏</div></div>
                <div id="impostoMes" class="val r">R$ 0,00</div>
                <div class="sub" id="impostoMesRef">-</div>
            </div>
            <div class="card">
                <div class="card-head"><span class="card-label">Total Pago no Ano</span><div class="card-icon g">‚úÖ</div></div>
                <div id="impostoPagoAno" class="val g">R$ 0,00</div>
                <div class="sub" id="impostoAnoRef">Ano 2026</div>
            </div>
            <div class="card">
                <div class="card-head"><span class="card-label">Imposto Pendente</span><div class="card-icon y">‚ö†Ô∏è</div></div>
                <div id="impostoPendente" class="val y">R$ 0,00</div>
                <div class="sub">A pagar</div>
            </div>
        </div>

        <div class="card" style="margin-bottom:16px">
            <h3 class="title"><span>üìÖ</span> Impostos por M√™s</h3>
            <div class="table-wrap">
                <table id="impostoTable">
                    <thead>
                        <tr>
                            <th>M√™s/Ano</th>
                            <th>Lucro L√≠quido</th>
                            <th>Imposto (20%)</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="impostoBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3 class="title"><span>‚ÑπÔ∏è</span> Informa√ß√µes Importantes</h3>
            <div class="plan-rule"><div class="rule-num">1</div><div class="rule-text"><strong>Al√≠quota:</strong> 20% sobre o lucro l√≠quido em Day Trade</div></div>
            <div class="plan-rule"><div class="rule-num">2</div><div class="rule-text"><strong>Vencimento:</strong> √öltimo dia √∫til do m√™s seguinte</div></div>
            <div class="plan-rule"><div class="rule-num">3</div><div class="rule-text"><strong>DARF:</strong> C√≥digo 6015 - Day Trade</div></div>
            <div class="plan-rule warning"><div class="rule-num">4</div><div class="rule-text"><strong>Isen√ß√£o:</strong> N√£o h√° isen√ß√£o para Day Trade (diferente de Swing Trade)</div></div>
            <div class="plan-rule"><div class="rule-num">5</div><div class="rule-text"><strong>Compensa√ß√£o:</strong> Preju√≠zos podem ser compensados nos meses seguintes</div></div>
            <div class="action-row" style="margin-top:16px">
                <a href="https://sicalc.receita.economia.gov.br/sicalc/principal" target="_blank" class="btn btn-p">üîó Emitir DARF (Sicalc)</a>
                <a href="https://www.gov.br/receitafederal/pt-br" target="_blank" class="btn btn-s">üîó Receita Federal</a>
            </div>
        </div>
    </div>

    <div id="manual" class="content">
        <div class="card" style="margin-bottom:16px">
            <h2 class="title" style="font-size:1.3rem"><span>üìñ</span> Manual do Mesa Tracker</h2>
            <p style="color:var(--muted)">Guia completo de todos os par√¢metros e funcionalidades do sistema</p>
        </div>

        <div class="card" style="margin-bottom:16px">
            <h3 class="title"><span>üìà</span> Dashboard - Vis√£o Geral</h3>
            
            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üéØ Progresso da Meta</h4>
                <div class="manual-item"><strong>Barra de progresso:</strong> Mostra visualmente quanto falta para atingir a meta de lucro. Calculado como (Saldo Atual √∑ Meta) √ó 100%</div>
                <div class="manual-item"><strong>Porcentagem:</strong> Percentual do progresso em rela√ß√£o √† meta definida</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--blue);margin-bottom:10px">üìÖ Tempo Restante</h4>
                <div class="manual-item"><strong>Dias Passados:</strong> Quantidade de dias desde a data de in√≠cio at√© hoje</div>
                <div class="manual-item"><strong>Dias Faltam:</strong> Quantidade de dias restantes no per√≠odo de 2 meses</div>
                <div class="manual-item"><strong>Total:</strong> Dura√ß√£o total do per√≠odo (aproximadamente 60 dias)</div>
                <div class="manual-item"><strong>Barra azul:</strong> Progresso visual do tempo consumido</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üí∞ Cards Principais</h4>
                <div class="manual-item"><strong>Saldo Atual:</strong> Saldo Inicial + Soma de todos os resultados das opera√ß√µes. √â o seu lucro acumulado.</div>
                <div class="manual-item"><strong>Falta p/ Meta:</strong> Meta - Saldo Atual. Quanto ainda precisa lucrar para bater a meta.</div>
                <div class="manual-item"><strong>Margem Perda:</strong> Limite + Saldo Atual. Quanto ainda pode perder antes de estourar o limite. Se ficar abaixo de R$500, aparece alerta vermelho.</div>
                <div class="manual-item"><strong>Taxa Acerto:</strong> (Opera√ß√µes Vencedoras √∑ Total de Opera√ß√µes) √ó 100%. N√£o conta opera√ß√µes zeradas.</div>
                <div class="manual-item"><strong>Total Ops:</strong> Quantidade total de opera√ß√µes registradas.</div>
                <div class="manual-item"><strong>Fator Lucro:</strong> Lucro Bruto √∑ Preju√≠zo Bruto. Acima de 1.0 significa que voc√™ lucra mais do que perde.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üöÄ Proje√ß√£o</h4>
                <div class="manual-item"><strong>Dias estimados:</strong> Falta p/ Meta √∑ M√©dia por dia. Previs√£o de quantos dias faltam para bater a meta mantendo a performance atual.</div>
                <div class="manual-item"><strong>M√©dia/dia:</strong> (Saldo Atual - Saldo Inicial) √∑ Quantidade de dias operados. Seu resultado m√©dio di√°rio.</div>
                <div class="manual-item"><strong>Ops necess√°rias:</strong> Falta p/ Meta √∑ (M√©dia Gain √ó Taxa Acerto). Quantas opera√ß√µes ainda precisa para bater a meta.</div>
                <div class="manual-item"><strong>Lucro aprova√ß√£o:</strong> Saldo Atual √ó Repasse%. Quanto voc√™ receberia HOJE se fosse aprovado com o saldo atual.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üí∞ Financeiro</h4>
                <div class="manual-item"><strong>Lucro Bruto:</strong> Soma de todas as opera√ß√µes positivas (gains).</div>
                <div class="manual-item"><strong>Preju√≠zo Bruto:</strong> Soma de todas as opera√ß√µes negativas (losses) em valor absoluto.</div>
                <div class="manual-item"><strong>M√©dia Gain:</strong> Lucro Bruto √∑ Quantidade de opera√ß√µes vencedoras.</div>
                <div class="manual-item"><strong>M√©dia Loss:</strong> Preju√≠zo Bruto √∑ Quantidade de opera√ß√µes perdedoras.</div>
                <div class="manual-item"><strong>Maior Gain:</strong> Valor da maior opera√ß√£o vencedora.</div>
                <div class="manual-item"><strong>Maior Loss:</strong> Valor da maior opera√ß√£o perdedora.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--blue);margin-bottom:10px">üìä Opera√ß√µes</h4>
                <div class="manual-item"><strong>Vencedoras:</strong> Total de opera√ß√µes com resultado positivo.</div>
                <div class="manual-item"><strong>Perdedoras:</strong> Total de opera√ß√µes com resultado negativo.</div>
                <div class="manual-item"><strong>Zeradas:</strong> Opera√ß√µes com resultado R$0,00.</div>
                <div class="manual-item"><strong>Raz√£o R:R:</strong> M√©dia Gain √∑ M√©dia Loss. Quanto voc√™ ganha em m√©dia para cada R$1 que perde.</div>
                <div class="manual-item"><strong>Seq Win:</strong> Maior sequ√™ncia consecutiva de opera√ß√µes vencedoras.</div>
                <div class="manual-item"><strong>Seq Loss:</strong> Maior sequ√™ncia consecutiva de opera√ß√µes perdedoras.</div>
            </div>
        </div>

        <div class="card" style="margin-bottom:16px">
            <h3 class="title"><span>üìù</span> Registrar - Importar e Cadastrar</h3>
            
            <div class="manual-section">
                <h4 style="color:var(--yellow);margin-bottom:10px">üì§ Importar CSV da Mesa</h4>
                <div class="manual-item"><strong>Como usar:</strong> Clique na √°rea pontilhada e selecione o arquivo CSV exportado da sua mesa propriet√°ria.</div>
                <div class="manual-item"><strong>Duplicatas:</strong> O sistema detecta opera√ß√µes j√° importadas e ignora automaticamente. Apenas opera√ß√µes novas s√£o adicionadas.</div>
                <div class="manual-item"><strong>Formato aceito:</strong> CSV com separador ponto-v√≠rgula (;) no formato da LTX Capital.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üìù Registro Manual</h4>
                <div class="manual-item"><strong>Data/Hora:</strong> Data e hor√°rio da opera√ß√£o.</div>
                <div class="manual-item"><strong>Ativo:</strong> WIN (Mini √çndice), WDO (Mini D√≥lar), IND (√çndice Cheio), DOL (D√≥lar Cheio).</div>
                <div class="manual-item"><strong>Dire√ß√£o:</strong> Compra (üü¢) ou Venda (üî¥).</div>
                <div class="manual-item"><strong>Contratos:</strong> Quantidade de contratos operados.</div>
                <div class="manual-item"><strong>Entrada/Sa√≠da:</strong> Pre√ßos de entrada e sa√≠da em pontos (opcional).</div>
                <div class="manual-item"><strong>Resultado R$:</strong> Resultado financeiro da opera√ß√£o. Use valores positivos para gain e negativos para loss.</div>
                <div class="manual-item"><strong>Setup:</strong> Estrat√©gia utilizada (opcional, para an√°lise posterior).</div>
                <div class="manual-item"><strong>Qualidade:</strong> Avalia√ß√£o da opera√ß√£o - Boa, Ruim, Emocional ou Neutra.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--red);margin-bottom:10px">üóëÔ∏è Limpar Todos Registros</h4>
                <div class="manual-item"><strong>Fun√ß√£o:</strong> Remove TODAS as opera√ß√µes registradas. As configura√ß√µes s√£o mantidas. Use com cuidado!</div>
            </div>
        </div>

        <div class="card" style="margin-bottom:16px">
            <h3 class="title"><span>üîç</span> An√°lise - Performance Detalhada</h3>
            
            <div class="manual-section">
                <h4 style="color:var(--blue);margin-bottom:10px">üìÖ Por Dia da Semana</h4>
                <div class="manual-item"><strong>Cards Seg-Sex:</strong> Mostra o resultado acumulado e quantidade de opera√ß√µes para cada dia da semana.</div>
                <div class="manual-item"><strong>Borda verde:</strong> Seu melhor dia da semana.</div>
                <div class="manual-item"><strong>Borda vermelha:</strong> Seu pior dia da semana.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üéØ Por Setup</h4>
                <div class="manual-item"><strong>Lista de setups:</strong> Mostra resultado acumulado, quantidade de opera√ß√µes e taxa de acerto para cada setup utilizado.</div>
                <div class="manual-item"><strong>Ordena√ß√£o:</strong> Setups s√£o ordenados do mais lucrativo para o menos lucrativo.</div>
            </div>
        </div>

        <div class="card" style="margin-bottom:16px">
            <h3 class="title"><span>üßÆ</span> Calculadora - Gest√£o de Risco</h3>
            
            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üßÆ Gest√£o de Risco</h4>
                <div class="manual-item"><strong>Margem risco R$:</strong> Quanto voc√™ est√° disposto a arriscar no total (ex: R$500).</div>
                <div class="manual-item"><strong>Risco %:</strong> Percentual da margem que vai arriscar por opera√ß√£o (ex: 2%).</div>
                <div class="manual-item"><strong>Stop (pts):</strong> Dist√¢ncia do stop loss em pontos.</div>
                <div class="manual-item"><strong>Valor ponto:</strong> Valor financeiro de cada ponto do ativo (WIN=R$0,20, WDO=R$10).</div>
                <div class="manual-item"><strong>Raz√£o R:R:</strong> Rela√ß√£o Risco/Retorno desejada. Se 2:1, seu gain ser√° 2x o stop.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--blue);margin-bottom:10px">üìä Resultados da Calculadora</h4>
                <div class="manual-item"><strong>Risco m√°x:</strong> Margem √ó Risco%. M√°ximo que pode perder na opera√ß√£o.</div>
                <div class="manual-item"><strong>Contratos:</strong> Risco m√°x √∑ (Stop √ó Valor ponto). Limitado ao m√°ximo do plano.</div>
                <div class="manual-item"><strong>Perda c/ stop:</strong> Contratos √ó Stop √ó Valor ponto. Perda real se stopar.</div>
                <div class="manual-item"><strong>Gain:</strong> Stop √ó Raz√£o R:R. Alvo em pontos.</div>
                <div class="manual-item"><strong>Lucro potencial:</strong> Contratos √ó Gain √ó Valor ponto. Ganho se atingir o alvo.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üéØ Simulador de Meta</h4>
                <div class="manual-item"><strong>Falta p/ meta R$:</strong> Preenchido automaticamente com quanto falta para a meta.</div>
                <div class="manual-item"><strong>M√©dia gain R$:</strong> Valor m√©dio esperado por opera√ß√£o vencedora.</div>
                <div class="manual-item"><strong>M√©dia loss R$:</strong> Valor m√©dio de perda por opera√ß√£o perdedora. Se n√£o preencher, usa o mesmo valor do gain.</div>
                <div class="manual-item"><strong>Ops/dia:</strong> Quantas opera√ß√µes pretende fazer por dia.</div>
                <div class="manual-item"><strong>Taxa acerto %:</strong> Taxa de acerto esperada.</div>
                <div class="manual-item"><strong>Dias oper√°veis:</strong> Quantos dias ainda vai operar no per√≠odo.</div>
                <div class="manual-item"><strong>Expectativa/opera√ß√£o:</strong> (Gain √ó WinRate) - (Loss √ó LossRate). Quanto espera ganhar em m√©dia por opera√ß√£o.</div>
                <div class="manual-item"><strong>Expectativa/dia:</strong> Expectativa por opera√ß√£o √ó Ops por dia.</div>
                <div class="manual-item"><strong>Wins necess√°rios:</strong> Falta √∑ Gain. Quantas opera√ß√µes vencedoras precisa.</div>
                <div class="manual-item"><strong>Total ops (c/ WR):</strong> Wins necess√°rios √∑ WinRate. Total de opera√ß√µes considerando que nem todas ser√£o vencedoras.</div>
                <div class="manual-item"><strong>Dias estimados:</strong> Total ops √∑ Ops por dia. Previs√£o de quantos dias precisa operando.</div>
                <div class="manual-item"><strong>Meta di√°ria:</strong> Falta √∑ Dias oper√°veis. Quanto precisa fazer por dia para bater a meta no tempo restante.</div>
            </div>
        </div>

        <div class="card" style="margin-bottom:16px">
            <h3 class="title"><span>‚öôÔ∏è</span> Configura√ß√µes</h3>
            
            <div class="manual-section">
                <h4 style="color:var(--yellow);margin-bottom:10px">üîÑ Modo Normal vs Teste</h4>
                <div class="manual-item"><strong>Normal:</strong> Usa a data de in√≠cio real da sua mesa.</div>
                <div class="manual-item"><strong>Teste:</strong> Permite definir uma data de in√≠cio fict√≠cia para simular cen√°rios.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üìã Planos</h4>
                <div class="manual-item"><strong>Starter:</strong> 6 contratos, Meta R$2.200, Limite R$2.500</div>
                <div class="manual-item"><strong>PRO:</strong> 12 contratos, Meta R$5.500, Limite R$5.800</div>
                <div class="manual-item"><strong>Master:</strong> 24 contratos, Meta R$9.000, Limite R$10.000</div>
                <div class="manual-item"><strong>Black:</strong> 57 contratos, Meta R$20.000, Limite R$24.000</div>
                <div class="manual-item"><strong>Platinum:</strong> 250 contratos, Meta R$25.000, Limite R$30.000</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--blue);margin-bottom:10px">üéØ Metas e Limites</h4>
                <div class="manual-item"><strong>Meta R$:</strong> Valor que precisa atingir para ser aprovado.</div>
                <div class="manual-item"><strong>Limite R$:</strong> Perda m√°xima permitida (valor negativo). Se Saldo atingir -Limite, reprova.</div>
                <div class="manual-item"><strong>M√°x Cts:</strong> Quantidade m√°xima de contratos permitida pelo plano.</div>
                <div class="manual-item"><strong>Repasse %:</strong> Percentual do lucro que voc√™ recebe ap√≥s aprova√ß√£o (geralmente 80%).</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üíæ Backup</h4>
                <div class="manual-item"><strong>Local:</strong> Salva/restaura dados em arquivo JSON no seu computador.</div>
                <div class="manual-item"><strong>Nuvem (Gist):</strong> Sincroniza dados com GitHub Gist para backup autom√°tico.</div>
                <div class="manual-item"><strong>Token:</strong> Crie em github.com ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic) ‚Üí Generate new token ‚Üí Marque "gist".</div>
                <div class="manual-item"><strong>Gist ID:</strong> Deixe vazio na primeira vez. Ap√≥s backup, ser√° preenchido automaticamente.</div>
            </div>
        </div>

        <div class="card">
            <h3 class="title"><span>‚òÅÔ∏è</span> Bot√µes de Nuvem (Header)</h3>
            <div class="manual-section">
                <div class="manual-item"><strong>Bot√£o escuro (‚òÅÔ∏è‚Üë):</strong> Faz backup dos dados para o GitHub Gist.</div>
                <div class="manual-item"><strong>Bot√£o azul (‚òÅÔ∏è‚Üì):</strong> Restaura os dados do GitHub Gist.</div>
                <div class="manual-item"><strong>Auto-restore:</strong> Ao abrir o app, se configurado, restaura automaticamente da nuvem.</div>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <h3 class="title"><span>üí∞</span> Imposto - Day Trade</h3>
            
            <div class="manual-section">
                <h4 style="color:var(--red);margin-bottom:10px">üìã Regras do Imposto</h4>
                <div class="manual-item"><strong>Al√≠quota:</strong> 20% sobre o lucro l√≠quido mensal em opera√ß√µes Day Trade.</div>
                <div class="manual-item"><strong>N√£o h√° isen√ß√£o:</strong> Diferente do Swing Trade (que tem isen√ß√£o at√© R$20mil/m√™s), Day Trade paga imposto sobre qualquer lucro.</div>
                <div class="manual-item"><strong>Lucro L√≠quido:</strong> Total de ganhos - Total de perdas no m√™s. S√≥ paga imposto se o resultado for positivo.</div>
                <div class="manual-item"><strong>Compensa√ß√£o de preju√≠zo:</strong> Preju√≠zos de meses anteriores podem ser compensados nos meses seguintes.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--yellow);margin-bottom:10px">üìÖ Vencimento e Pagamento</h4>
                <div class="manual-item"><strong>Vencimento:</strong> √öltimo dia √∫til do m√™s seguinte ao da apura√ß√£o. Ex: lucro de Janeiro, paga at√© fim de Fevereiro.</div>
                <div class="manual-item"><strong>DARF:</strong> Documento de Arrecada√ß√£o de Receitas Federais - c√≥digo 6015 (Day Trade).</div>
                <div class="manual-item"><strong>Valor m√≠nimo:</strong> DARF s√≥ pode ser emitido se o imposto for maior que R$10,00. Se for menor, acumula para o pr√≥ximo m√™s.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üîó Como Pagar o DARF</h4>
                <div class="manual-item"><strong>1.</strong> Acesse o site do Sicalc: <a href="https://sicalc.receita.economia.gov.br/sicalc/principal" target="_blank" style="color:var(--blue)">sicalc.receita.economia.gov.br</a></div>
                <div class="manual-item"><strong>2.</strong> Selecione "Pagamento" ‚Üí "Preenchimento Manual"</div>
                <div class="manual-item"><strong>3.</strong> Informe: C√≥digo 6015, Per√≠odo de apura√ß√£o (m√™s/ano), CPF e valor do imposto</div>
                <div class="manual-item"><strong>4.</strong> Gere o DARF e pague via banco (internet banking, app ou ag√™ncia)</div>
                <div class="manual-item"><strong>5.</strong> Guarde o comprovante para declara√ß√£o do IR</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--blue);margin-bottom:10px">üìù Declara√ß√£o Anual (IRPF)</h4>
                <div class="manual-item"><strong>Onde declarar:</strong> Programa IRPF da Receita Federal, na ficha "Renda Vari√°vel" ‚Üí "Opera√ß√µes Comuns/Day Trade"</div>
                <div class="manual-item"><strong>O que informar:</strong> Lucros, preju√≠zos, imposto pago (DARF) m√™s a m√™s</div>
                <div class="manual-item"><strong>Preju√≠zos:</strong> Informe os preju√≠zos para poder compensar em anos futuros</div>
                <div class="manual-item"><strong>DARF pago:</strong> Informe todos os DARFs pagos no campo "Imposto Pago"</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--green);margin-bottom:10px">üñ•Ô∏è Usando a Aba Imposto</h4>
                <div class="manual-item"><strong>Imposto Devido M√™s Atual:</strong> Calcula automaticamente 20% do lucro l√≠quido do m√™s corrente.</div>
                <div class="manual-item"><strong>Total Pago no Ano:</strong> Soma de todos os impostos que voc√™ marcou como "Pago" no ano atual.</div>
                <div class="manual-item"><strong>Imposto Pendente:</strong> Impostos de meses anteriores que ainda n√£o foram marcados como pagos.</div>
                <div class="manual-item"><strong>Tabela de Meses:</strong> Lista todos os meses com opera√ß√µes, lucro l√≠quido, imposto calculado e status de pagamento.</div>
                <div class="manual-item"><strong>Marcar Pago:</strong> Ap√≥s pagar o DARF, clique em "Marcar Pago" para atualizar o controle.</div>
            </div>

            <div class="manual-section">
                <h4 style="color:var(--red);margin-bottom:10px">‚ö†Ô∏è Importante</h4>
                <div class="manual-item"><strong>Multa por atraso:</strong> 0,33% ao dia (m√°x 20%) + juros Selic. Pague em dia!</div>
                <div class="manual-item"><strong>Este sistema √© auxiliar:</strong> Consulte um contador para casos espec√≠ficos. O Mesa Tracker calcula automaticamente mas n√£o substitui orienta√ß√£o profissional.</div>
            </div>
        </div>
    </div>
</div>
<div id="toast" class="toast"></div>
<script>
// ==================== CONFIGURA√á√ÉO DO BACKEND ====================
const API_URL = 'https://mesa-trader-api.onrender.com';

// ==================== ESTADO DA AUTENTICA√á√ÉO ====================
let authToken = localStorage.getItem('mesa_token') || null;
let currentUser = null;
let currentLicense = null;

// ==================== FUN√á√ïES DE API ====================
async function api(endpoint, method = 'GET', data = null) {
    const options = { method, headers: { 'Content-Type': 'application/json' } };
    if (authToken) options.headers['Authorization'] = `Bearer ${authToken}`;
    if (data) options.body = JSON.stringify(data);
    try {
        const response = await fetch(`${API_URL}${endpoint}`, options);
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Erro na requisi√ß√£o');
        return result;
    } catch (error) { console.error('API Error:', error); throw error; }
}

// ==================== AUTENTICA√á√ÉO ====================
function showAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
    ['authError', 'authSuccess', 'regError', 'regSuccess'].forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
}

async function doLogin() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const btn = document.getElementById('authBtn');
    const errorEl = document.getElementById('authError');
    const successEl = document.getElementById('authSuccess');
    errorEl.style.display = 'none'; successEl.style.display = 'none';
    if (!email || !password) { errorEl.textContent = 'Preencha email e senha'; errorEl.style.display = 'block'; return; }
    btn.disabled = true; btn.textContent = '‚è≥ Entrando...';
    try {
        const result = await api('/api/login', 'POST', { email, password });
        authToken = result.token; currentUser = result.user; currentLicense = result.license;
        localStorage.setItem('mesa_token', authToken);
        successEl.textContent = '‚úÖ Login realizado!'; successEl.style.display = 'block';
        setTimeout(() => { if (currentLicense) { showApp(); initApp(); } else { document.getElementById('activateForm').style.display = 'block'; toast('Ative sua licen√ßa'); } }, 1000);
    } catch (error) { errorEl.textContent = error.message || 'Erro ao fazer login'; errorEl.style.display = 'block'; }
    btn.disabled = false; btn.textContent = 'üîì Entrar';
}

async function doRegister() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    const btn = document.getElementById('regBtn');
    const errorEl = document.getElementById('regError');
    const successEl = document.getElementById('regSuccess');
    errorEl.style.display = 'none'; successEl.style.display = 'none';
    if (!email || !password) { errorEl.textContent = 'Preencha todos os campos'; errorEl.style.display = 'block'; return; }
    if (password.length < 6) { errorEl.textContent = 'Senha deve ter no m√≠nimo 6 caracteres'; errorEl.style.display = 'block'; return; }
    btn.disabled = true; btn.textContent = '‚è≥ Criando...';
    try {
        const result = await api('/api/register', 'POST', { name, email, password });
        authToken = result.token; currentUser = result.user;
        localStorage.setItem('mesa_token', authToken);
        successEl.textContent = '‚úÖ Conta criada! Ative sua licen√ßa'; successEl.style.display = 'block';
        document.getElementById('activateForm').style.display = 'block';
    } catch (error) { errorEl.textContent = error.message || 'Erro ao criar conta'; errorEl.style.display = 'block'; }
    btn.disabled = false; btn.textContent = '‚ú® Criar Conta';
}

async function activateLicense() {
    const code = document.getElementById('licenseCode').value.trim().toUpperCase();
    if (!code) { toast('Digite o c√≥digo da licen√ßa', 'error'); return; }
    try {
        const result = await api('/api/license/activate', 'POST', { code });
        currentLicense = result.license;
        toast('‚úÖ Licen√ßa ativada!');
        setTimeout(() => { showApp(); initApp(); }, 1000);
    } catch (error) { toast(error.message || 'C√≥digo inv√°lido', 'error'); }
}

async function checkAuth() {
    if (!authToken) { showAuthScreen(); return false; }
    try {
        const result = await api('/api/me');
        currentUser = result.user; currentLicense = result.license;
        if (!currentLicense) { showAuthScreen(); document.getElementById('activateForm').style.display = 'block'; return false; }
        return true;
    } catch (error) { localStorage.removeItem('mesa_token'); authToken = null; showAuthScreen(); return false; }
}

function showAuthScreen() { document.getElementById('authOverlay').style.display = 'flex'; document.getElementById('mainApp').style.display = 'none'; }
function showApp() { document.getElementById('authOverlay').style.display = 'none'; document.getElementById('mainApp').style.display = 'block'; }
function doLogout() { if (confirm('Sair da conta?')) { localStorage.removeItem('mesa_token'); localStorage.removeItem('mesa'); authToken = null; currentUser = null; currentLicense = null; location.reload(); } }

// ==================== SYNC COM BACKEND ====================
let saveTimeout = null;
async function saveToCloud(manual = false) {
    if (!authToken) return;
    try { await api('/api/data/save', 'POST', { data: D }); if (manual) toast('‚úÖ Salvo na nuvem!'); }
    catch (error) { if (manual) toast('‚ùå Erro ao salvar', 'error'); }
}
async function loadFromCloud() {
    if (!authToken) return;
    try {
        const result = await api('/api/data/load');
        if (result.data) { D = { ...D, ...result.data }; save(); load(); update(); toast('‚úÖ Dados carregados!'); }
        else { toast('Nenhum dado na nuvem'); }
    } catch (error) { toast('‚ùå Erro ao carregar', 'error'); }
}
function autoSaveCloud() { if (saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(() => saveToCloud(), 5000); }

// ==================== DADOS ====================
let D={settings:{plan:'starter',meta:2200,limite:2500,maxCts:6,repasse:80,saldo:0,dataInicio:'',mode:'normal',testDate:''},trades:[],gist:{token:'',id:''},setups:['Rompimento','Pullback','Revers√£o','Fluxo','SMC','Wyckoff','Price Action','Scalp'],qualidades:['‚úÖ Boa','‚ùå Ruim','üò§ Emocional','üòê Neutra'],impostos:{}};
const plans={starter:{c:6,m:2200,l:2500},pro:{c:12,m:5500,l:5800},master:{c:24,m:9000,l:10000},black:{c:57,m:20000,l:24000},platinum:{c:250,m:25000,l:30000}};

// ==================== INIT ====================
async function initApp() { load(); tabs(); defDate(); modeUI(); updateSetupSelect(); updateQualSelect(); updateSetupList(); updateQualList(); update(); updateImposto(); gistUI(); await loadFromCloud(); }
document.addEventListener('DOMContentLoaded', async () => { try { const isAuth = await checkAuth(); if (isAuth) await initApp(); } catch (e) { console.error(e); } });

// Register Service Worker for PWA
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').then(()=>console.log('SW registrado')).catch(e=>console.log('SW erro:',e))}

function toast(m,t='success'){const e=document.getElementById('toast');e.textContent=m;e.className=`toast ${t} show`;setTimeout(()=>e.classList.remove('show'),3000)}
function tabs(){document.querySelectorAll('.tab').forEach(t=>t.onclick=function(){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.content').forEach(x=>x.classList.remove('active'));this.classList.add('active');document.getElementById(this.dataset.tab).classList.add('active')})}
function defDate(){document.getElementById('tDate').value=new Date().toISOString().split('T')[0];const n=new Date();document.getElementById('tTime').value=n.getHours().toString().padStart(2,'0')+':'+n.getMinutes().toString().padStart(2,'0')}
function fmt(v){return'R$ '+v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}
function save(){localStorage.setItem('mesa',JSON.stringify(D));autoSaveCloud()}
function load(){const s=localStorage.getItem('mesa');if(s){const parsed=JSON.parse(s);D={...D,...parsed};if(!D.setups||!D.setups.length)D.setups=['Rompimento','Pullback','Revers√£o','Fluxo','SMC','Wyckoff','Price Action','Scalp'];if(!D.qualidades||!D.qualidades.length)D.qualidades=['‚úÖ Boa','‚ùå Ruim','üò§ Emocional','üòê Neutra'];if(!D.impostos)D.impostos={};document.getElementById('sPlan').value=D.settings.plan;document.getElementById('sMeta').value=D.settings.meta;document.getElementById('sLimite').value=D.settings.limite;document.getElementById('sCts').value=D.settings.maxCts;document.getElementById('sRepasse').value=D.settings.repasse;document.getElementById('sSaldo').value=D.settings.saldo;document.getElementById('sData').value=D.settings.dataInicio||'';document.getElementById('sTestDate').value=D.settings.testDate||'';document.getElementById('gToken').value=D.gist?.token||'';document.getElementById('gId').value=D.gist?.id||'';document.getElementById('planBadge').textContent=D.settings.plan.toUpperCase()}}
function setMode(m){D.settings.mode=m;document.getElementById('modeN').classList.toggle('active',m==='normal');document.getElementById('modeT').classList.toggle('active',m==='test');document.getElementById('modeT').classList.toggle('test-active',m==='test');document.getElementById('testSection').classList.toggle('visible',m==='test');modeUI();save();update()}
function modeUI(){const b=document.getElementById('modeBadge');if(D.settings.mode==='test'){b.textContent='Teste';b.className='badge test';document.getElementById('modeT').classList.add('active','test-active');document.getElementById('modeN').classList.remove('active');document.getElementById('testSection').classList.add('visible')}else{b.textContent='Normal';b.className='badge normal';document.getElementById('modeN').classList.add('active');document.getElementById('modeT').classList.remove('active','test-active');document.getElementById('testSection').classList.remove('visible')}}
function calcDays(){let s,e,t=new Date();if(D.settings.mode==='test'&&D.settings.testDate)s=new Date(D.settings.testDate+'T12:00:00');else s=D.settings.dataInicio?new Date(D.settings.dataInicio+'T12:00:00'):new Date();e=new Date(s);e.setMonth(e.getMonth()+2);const total=Math.ceil((e-s)/(1000*60*60*24)),passed=Math.max(0,Math.ceil((t-s)/(1000*60*60*24))),left=Math.max(0,total-passed),pct=Math.min(100,(passed/total)*100);return{total,passed,left,pct}}

function stats(){
    const t=D.trades;
    const tW=t.filter(x=>x.result>0),tL=t.filter(x=>x.result<0),tZ=t.filter(x=>x.result===0);
    const tGP=tW.reduce((s,x)=>s+x.result,0),tGL=Math.abs(tL.reduce((s,x)=>s+x.result,0));
    const totW=tW.length,totL=tL.length,totOps=t.length;
    const net=t.reduce((s,x)=>s+x.result,0),bal=D.settings.saldo+net;
    const wr=totOps>0?(totW/(totW+totL||1))*100:0,pf=tGL>0?tGP/tGL:tGP>0?999:0;
    const avgW=tW.length>0?tGP/tW.length:0,avgL=tL.length>0?tGL/tL.length:0,rr=avgL>0?avgW/avgL:0;
    const maxW=tW.length>0?Math.max(...tW.map(x=>x.result)):0,maxL=tL.length>0?Math.abs(Math.min(...tL.map(x=>x.result))):0;
    let mWS=0,mLS=0,seq=0,last=null;
    t.forEach(x=>{if(x.result>0){seq=last==='w'?seq+1:1;last='w';mWS=Math.max(mWS,seq)}else if(x.result<0){seq=last==='l'?seq+1:1;last='l';mLS=Math.max(mLS,seq)}});
    return{bal,falta:D.settings.meta-bal,margem:D.settings.limite+bal,totOps,totW,totL,totZ:tZ.length,wr,pf,tGP,tGL,avgW,avgL,rr,maxW,maxL,mWS,mLS,prog:(bal/D.settings.meta)*100}
}

function update(){
    const s=stats(),d=calcDays();
    const prog=Math.min(Math.max(s.prog,0),100);
    document.getElementById('progBar').style.width=prog+'%';
    document.getElementById('progPct').textContent=prog.toFixed(1)+'%';
    document.getElementById('progCurrent').textContent=fmt(s.bal);
    document.getElementById('progMeta').textContent=fmt(D.settings.meta);
    document.getElementById('daysBar').style.width=d.pct+'%';
    document.getElementById('daysPct').textContent=d.pct.toFixed(0)+'%';
    document.getElementById('daysPassed').textContent=d.passed;
    document.getElementById('daysLeft').textContent=d.left;
    document.getElementById('daysTotal').textContent=d.total;
    document.getElementById('saldo').textContent=fmt(s.bal);
    document.getElementById('falta').textContent=fmt(Math.max(0,s.falta));
    document.getElementById('margem').textContent=fmt(s.margem);
    document.getElementById('winrate').textContent=s.wr.toFixed(1)+'%';
    document.getElementById('totalOps').textContent=s.totOps;
    document.getElementById('pf').textContent=s.pf.toFixed(2);
    document.getElementById('lucroBruto').textContent=fmt(s.tGP);
    document.getElementById('prejBruto').textContent=fmt(s.tGL);
    document.getElementById('mediaGain').textContent=fmt(s.avgW);
    document.getElementById('mediaLoss').textContent=fmt(s.avgL);
    document.getElementById('maiorGain').textContent=fmt(s.maxW);
    document.getElementById('maiorLoss').textContent=fmt(s.maxL);
    document.getElementById('wins').textContent=s.totW;
    document.getElementById('losses').textContent=s.totL;
    document.getElementById('zeros').textContent=s.totZ;
    document.getElementById('rr').textContent=s.rr.toFixed(2);
    document.getElementById('seqW').textContent=s.mWS;
    document.getElementById('seqL').textContent=s.mLS;
    document.getElementById('histCount').textContent=D.trades.length;
    if(D.trades.length>0){
        const days=[...new Set(D.trades.map(t=>t.date))],avg=days.length>0?(s.bal-D.settings.saldo)/days.length:0;
        const dToM=avg>0?Math.ceil(s.falta/avg):'-',ops=s.avgW>0&&s.wr>0?Math.ceil(s.falta/(s.avgW*(s.wr/100))):'-',lucro=s.bal*(D.settings.repasse/100);
        document.getElementById('projDias').textContent=dToM;
        document.getElementById('projMedia').textContent=fmt(avg);
        document.getElementById('projOps').textContent=ops;
        document.getElementById('projLucro').textContent=fmt(lucro);
    }
    document.getElementById('simFalta').value=Math.max(0,s.falta).toFixed(2);
    document.getElementById('simDays').value=d.left;
    updateAlert(s);updateHist();updateAnalysis();updateImposto();
}

function updateAlert(s){const a=document.getElementById('statusAlert'),t=document.getElementById('alertText');if(s.bal>=D.settings.meta){a.className='alert alert-success';t.textContent='üéâ META BATIDA!'}else if(s.margem<500){a.className='alert alert-danger';t.textContent='‚ö†Ô∏è CUIDADO! Margem baixa!'}else if(s.prog>=80){a.className='alert alert-success';t.textContent='üî• Quase l√°!'}else if(s.prog>=50){a.className='alert alert-success';t.textContent='‚úÖ Bom progresso!'}else{a.className='alert alert-warning';t.textContent='üí™ Continue firme!'}}

function updateHist(){
    const c=document.getElementById('historyTable');
    if(!D.trades.length){c.innerHTML='<div class="empty">üì≠ Nenhuma opera√ß√£o</div>';return}
    const sorted=[...D.trades].sort((a,b)=>new Date(b.date+'T'+(b.time||'12:00'))-new Date(a.date+'T'+(a.time||'12:00')));
    let h='<table><thead><tr><th>Data</th><th>Hora</th><th>Ativo</th><th>Dir</th><th>Cts</th><th>R$</th><th>A√ß√µes</th></tr></thead><tbody>';
    sorted.forEach(t=>{const cls=t.result>0?'pos':t.result<0?'neg':'';h+=`<tr><td>${new Date(t.date+'T12:00:00').toLocaleDateString('pt-BR')}</td><td>${t.time||'-'}</td><td>${t.asset}</td><td>${t.dir==='C'?'üü¢':'üî¥'}</td><td>${t.cts}</td><td class="${cls}">${fmt(t.result)}</td><td><button class="btn-edit" onclick="editTrade('${t.id}')">‚úèÔ∏è</button><button class="btn-del" onclick="delTrade('${t.id}')">üóëÔ∏è</button></td></tr>`});
    h+='</tbody></table>';c.innerHTML=h;
}

function updateAnalysis(){
    const dayNames=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'],dayData={};
    [1,2,3,4,5].forEach(d=>dayData[d]={total:0,count:0});
    D.trades.forEach(t=>{const day=new Date(t.date+'T12:00:00').getDay();if(day>=1&&day<=5){dayData[day].total+=t.result;dayData[day].count++}});
    let best=null,worst=null,bR=-Infinity,wR=Infinity;
    Object.keys(dayData).forEach(d=>{if(dayData[d].count>0){if(dayData[d].total>bR){bR=dayData[d].total;best=d}if(dayData[d].total<wR){wR=dayData[d].total;worst=d}}});
    let h='';[1,2,3,4,5].forEach(d=>{const data=dayData[d],isBest=d==best&&data.count>0,isWorst=d==worst&&data.count>0&&data.total<0,cls=data.total>0?'g':data.total<0?'r':'';h+=`<div class="day-card ${isBest?'best':''} ${isWorst?'worst':''}"><div class="day-name">${dayNames[d]}</div><div class="day-result ${cls}">${data.count>0?fmt(data.total):'-'}</div><div class="day-trades">${data.count} ops</div></div>`});
    document.getElementById('dayAnalysis').innerHTML=h;
    const withSetup=D.trades.filter(t=>t.setup);
    if(!withSetup.length){document.getElementById('setupAnalysis').innerHTML='<div class="empty">Registre com setup</div>';return}
    const sd={};withSetup.forEach(t=>{if(!sd[t.setup])sd[t.setup]={total:0,wins:0,losses:0};sd[t.setup].total+=t.result;if(t.result>0)sd[t.setup].wins++;else if(t.result<0)sd[t.setup].losses++});
    let sh='<div style="display:flex;flex-direction:column;gap:8px">';
    Object.entries(sd).sort((a,b)=>b[1].total-a[1].total).forEach(([s,data])=>{const tot=data.wins+data.losses,wr=tot>0?(data.wins/tot*100).toFixed(0):0,cls=data.total>0?'g':data.total<0?'r':'';sh+=`<div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg);border-radius:8px"><div><div style="font-weight:600">${s}</div><div style="font-size:.75rem;color:var(--muted)">${tot} ops | ${wr}%</div></div><div class="val ${cls}" style="font-size:1rem">${fmt(data.total)}</div></div>`});
    sh+='</div>';document.getElementById('setupAnalysis').innerHTML=sh;
}

// Import CSV
function importCSV(event){
    const file=event.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=function(e){
        const text=e.target.result;
        const lines=text.split('\n');
        let newCount=0,skipCount=0;
        
        for(let i=6;i<lines.length;i++){
            const line=lines[i].trim();
            if(!line)continue;
            const cols=line.split(';');
            if(cols.length<12)continue;
            
            const ativo=cols[1]||'';
            const abertura=cols[2]||'';
            const lado=cols[7]||'';
            const resultado=cols[11]||'0';
            const qtd=parseInt(cols[5])||1;
            const numOp=cols[13]||'';
            
            if(!abertura||!ativo)continue;
            
            // Parse date/time: "26/11/2025 11:14:49"
            const dtParts=abertura.split(' ');
            const dateParts=dtParts[0].split('/');
            const date=`${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
            const timeFull=dtParts[1]||'12:00:00';
            const time=timeFull.substring(0,5);
            
            // Parse result - handle Brazilian format "159.150,00" or "-46,00"
            let res=resultado.replace(/\./g,'').replace(',','.');
            res=parseFloat(res)||0;
            
            // Create unique ID: abertura completa (com segundos) garante unicidade
            const id=`csv-${abertura.replace(/[^0-9]/g,'')}-${numOp}`;
            
            // Check if already exists by ID or by exact match (date+time+result+asset+cts)
            const isDuplicate = D.trades.some(t => 
                t.id === id || 
                (t.date === date && t.time === time && t.result === res && t.cts === qtd)
            );
            
            if(isDuplicate){
                skipCount++;
                continue;
            }
            
            // Map asset
            let asset='WIN';
            if(ativo.includes('WDO')||ativo.includes('WDOG'))asset='WDO';
            else if(ativo.includes('IND'))asset='IND';
            else if(ativo.includes('DOL')&&!ativo.includes('WDO'))asset='DOL';
            
            D.trades.push({
                id,
                date,
                time,
                asset,
                dir:lado==='C'?'C':'V',
                cts:qtd,
                result:res,
                setup:'',
                qual:'neutra',
                entry:0,
                exit:0
            });
            newCount++;
        }
        
        save();
        update();
        
        const resultDiv=document.getElementById('importResult');
        resultDiv.style.display='block';
        resultDiv.innerHTML=`<div class="alert alert-success">‚úÖ Importado: ${newCount} novas opera√ß√µes | ${skipCount} j√° existentes (ignoradas)</div>`;
        document.getElementById('csvFile').value='';
        toast(`‚úÖ ${newCount} opera√ß√µes importadas!`);
    };
    reader.readAsText(file,'ISO-8859-1');
}

function addTrade(){
    const t={
        id:Date.now().toString(),
        date:document.getElementById('tDate').value,
        time:document.getElementById('tTime').value,
        asset:document.getElementById('tAsset').value,
        dir:document.getElementById('tDir').value,
        cts:parseInt(document.getElementById('tCts').value)||1,
        entry:parseFloat(document.getElementById('tEntry').value)||0,
        exit:parseFloat(document.getElementById('tExit').value)||0,
        result:parseFloat(document.getElementById('tResult').value)||0,
        setup:document.getElementById('tSetup').value,
        qual:document.getElementById('tQual').value
    };
    if(!t.date||t.result===0){toast('Preencha data e resultado!','error');return}
    D.trades.push(t);save();clearForm();update();toast('‚úÖ Opera√ß√£o salva!');document.querySelector('[data-tab="dashboard"]').click();
}

function clearForm(){['tEntry','tExit','tResult','tSetup'].forEach(id=>document.getElementById(id).value='');document.getElementById('tCts').value=1;defDate()}
function delTrade(id){if(confirm('Excluir?')){D.trades=D.trades.filter(t=>t.id!==id);save();update()}}
function clearAllTrades(){if(confirm('‚ö†Ô∏è Limpar TODOS os registros de opera√ß√µes?')){D.trades=[];save();update();toast('Registros limpos!')}}

function calcRisk(){const cap=parseFloat(document.getElementById('calcCap').value)||0,risk=parseFloat(document.getElementById('calcRisk').value)||2,stop=parseFloat(document.getElementById('calcStop').value)||100,pt=parseFloat(document.getElementById('calcPt').value)||0.2,rr=parseFloat(document.getElementById('calcRR').value)||2;const maxR=cap*(risk/100),lossPerCt=stop*pt,cts=Math.min(Math.floor(maxR/lossPerCt),D.settings.maxCts),loss=cts*lossPerCt,gain=stop*rr,profit=gain*pt*cts;document.getElementById('riskResult').innerHTML=`<div class="result-item"><span style="color:var(--muted)">Risco m√°x</span><span class="val g" style="font-size:1rem">${fmt(maxR)}</span></div><div class="result-item"><span style="color:var(--muted)">Contratos</span><span class="val b" style="font-size:1rem">${cts}</span></div><div class="result-item"><span style="color:var(--muted)">Perda c/ stop</span><span class="val r" style="font-size:1rem">${fmt(loss)}</span></div><div class="result-item"><span style="color:var(--muted)">Gain (${rr}:1)</span><span class="val g" style="font-size:1rem">${gain} pts</span></div><div class="result-item"><span style="color:var(--muted)">Lucro potencial</span><span class="val g" style="font-size:1rem">${fmt(profit)}</span></div>`;document.getElementById('riskResult').style.display='block'}
function simMeta(){
    const falta=parseFloat(document.getElementById('simFalta').value)||0;
    const gain=parseFloat(document.getElementById('simGain').value)||50;
    const loss=parseFloat(document.getElementById('simLoss').value)||gain;
    const ops=parseInt(document.getElementById('simOps').value)||3;
    const wr=parseFloat(document.getElementById('simWR').value)||50;
    const days=parseInt(document.getElementById('simDays').value)||20;
    
    // Expectativa por opera√ß√£o: (gain * winrate) - (loss * lossrate)
    const expOp=(gain*wr/100)-(loss*(1-wr/100));
    // Expectativa por dia
    const expDay=expOp*ops;
    // Dias para meta baseado na expectativa
    const dToM=expDay>0?Math.ceil(falta/expDay):'-';
    // Opera√ß√µes vencedoras necess√°rias
    const winsNeeded=Math.ceil(falta/gain);
    // Total de opera√ß√µes considerando winrate
    const totalOps=wr>0?Math.ceil(winsNeeded/(wr/100)):'-';
    // Dias necess√°rios baseado em ops/dia
    const daysNeeded=ops>0&&totalOps!=='-'?Math.ceil(totalOps/ops):'-';
    // Meta di√°ria obrigat√≥ria
    const req=days>0?falta/days:0;
    
    document.getElementById('simResult').innerHTML=`
        <div class="result-item"><span style="color:var(--muted)">Expectativa/opera√ß√£o</span><span class="val ${expOp>=0?'g':'r'}" style="font-size:1rem">${fmt(expOp)}</span></div>
        <div class="result-item"><span style="color:var(--muted)">Expectativa/dia</span><span class="val ${expDay>=0?'g':'r'}" style="font-size:1rem">${fmt(expDay)}</span></div>
        <div class="result-item"><span style="color:var(--muted)">Wins necess√°rios</span><span style="font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--green)">${winsNeeded}</span></div>
        <div class="result-item"><span style="color:var(--muted)">Total ops (c/ WR)</span><span style="font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--blue)">${totalOps}</span></div>
        <div class="result-item"><span style="color:var(--muted)">Dias estimados</span><span class="val b" style="font-size:1rem">${daysNeeded}</span></div>
        <div class="result-item" style="background:rgba(0,255,136,.1);margin:10px -16px -16px;padding:14px 16px;border-radius:0 0 12px 12px"><span style="color:var(--green)">üí∞ Meta di√°ria</span><span class="val g" style="font-size:1rem">${fmt(req)}</span></div>`;
    document.getElementById('simResult').style.display='block';
}
function updatePlan(){const p=document.getElementById('sPlan').value,c=plans[p];document.getElementById('sMeta').value=c.m;document.getElementById('sLimite').value=c.l;document.getElementById('sCts').value=c.c}
function saveSettings(){D.settings={...D.settings,plan:document.getElementById('sPlan').value,meta:parseFloat(document.getElementById('sMeta').value),limite:parseFloat(document.getElementById('sLimite').value),maxCts:parseInt(document.getElementById('sCts').value),repasse:parseFloat(document.getElementById('sRepasse').value),saldo:parseFloat(document.getElementById('sSaldo').value),dataInicio:document.getElementById('sData').value,testDate:document.getElementById('sTestDate').value};document.getElementById('planBadge').textContent=D.settings.plan.toUpperCase();save();update();toast('‚úÖ Salvo!')}
function backupLocal(){const b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`mesa-${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(u);toast('‚úÖ Backup baixado!')}
function restoreLocal(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=x=>{try{D={...D,...JSON.parse(x.target.result)};save();load();update();toast('‚úÖ Restaurado!')}catch{toast('‚ùå Erro','error')}};r.readAsText(f)}
function exportCSV(){if(!D.trades.length){toast('Sem dados','error');return}let c='Data,Hora,Ativo,Dir,Cts,Resultado,Setup,Qualidade\n';D.trades.forEach(t=>c+=`${t.date},${t.time||''},${t.asset},${t.dir},${t.cts},${t.result},${t.setup||''},${t.qual||''}\n`);const b=new Blob([c],{type:'text/csv'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`trades-${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(u);toast('‚úÖ CSV!')}
function saveGist(){D.gist={token:document.getElementById('gToken').value,id:document.getElementById('gId').value};save();gistUI();toast('‚úÖ Config salva!')}
function gistUI(){const s=document.getElementById('gStatus');if(D.gist.token&&D.gist.id){s.innerHTML='üü¢ Conectado';s.className='gist-status connected'}else if(D.gist.token){s.innerHTML='üü° Token OK';s.className='gist-status'}else{s.innerHTML='‚ö™ N√£o configurado';s.className='gist-status'}}
async function backupGist(){if(!D.gist.token){toast('Configure token!','error');return}const btn=document.querySelector('.cloud-btn.backup');btn.classList.add('loading');try{const data={...D};delete data.gist;const content=JSON.stringify(data,null,2);if(D.gist.id){const r=await fetch(`https://api.github.com/gists/${D.gist.id}`,{method:'PATCH',headers:{'Authorization':`token ${D.gist.token}`,'Content-Type':'application/json'},body:JSON.stringify({files:{'mesa-data.json':{content}}})});if(!r.ok)throw new Error();toast('‚úÖ Backup atualizado!')}else{const r=await fetch('https://api.github.com/gists',{method:'POST',headers:{'Authorization':`token ${D.gist.token}`,'Content-Type':'application/json'},body:JSON.stringify({description:'Mesa Tracker',public:false,files:{'mesa-data.json':{content}}})});if(!r.ok)throw new Error();const d=await r.json();D.gist.id=d.id;document.getElementById('gId').value=d.id;save();gistUI();toast('‚úÖ Gist criado!')}}catch(e){toast('‚ùå Erro backup','error')}finally{btn.classList.remove('loading')}}
async function restoreGist(silent){if(!D.gist.token||!D.gist.id){if(!silent)toast('Configure token e ID!','error');return}const btn=document.querySelector('.cloud-btn.restore');btn.classList.add('loading');try{const r=await fetch(`https://api.github.com/gists/${D.gist.id}`,{headers:{'Authorization':`token ${D.gist.token}`}});if(!r.ok)throw new Error();const d=await r.json(),c=d.files['mesa-data.json']?.content;if(!c)throw new Error();const restored=JSON.parse(c),gist=D.gist;D={...D,...restored,gist};save();load();update();if(!silent)toast('‚úÖ Restaurado da nuvem!')}catch(e){if(!silent)toast('‚ùå Erro restaurar','error')}finally{btn.classList.remove('loading')}}
function clearAll(){if(confirm('‚ö†Ô∏è APAGAR TUDO?')&&confirm('Confirma?')){localStorage.removeItem('mesa');location.reload()}}

// Fun√ß√µes de Setup e Qualidade
function updateSetupSelect(){
    const sel=document.getElementById('tSetup');
    sel.innerHTML='<option value="">Selecione...</option>';
    D.setups.forEach(s=>sel.innerHTML+=`<option value="${s}">${s}</option>`);
}
function updateQualSelect(){
    const sel=document.getElementById('tQual');
    sel.innerHTML='';
    D.qualidades.forEach(q=>sel.innerHTML+=`<option value="${q}">${q}</option>`);
}
function updateSetupList(){
    const list=document.getElementById('setupList');
    if(!list)return;
    list.innerHTML='';
    D.setups.forEach((s,i)=>list.innerHTML+=`<div class="custom-item"><span>${s}</span><button onclick="removeSetup(${i})">‚úï</button></div>`);
}
function updateQualList(){
    const list=document.getElementById('qualList');
    if(!list)return;
    list.innerHTML='';
    D.qualidades.forEach((q,i)=>list.innerHTML+=`<div class="custom-item"><span>${q}</span><button onclick="removeQual(${i})">‚úï</button></div>`);
}
function addSetup(){
    const input=document.getElementById('newSetup');
    const name=input.value.trim();
    if(!name){toast('Digite o nome do setup','error');return}
    if(D.setups.includes(name)){toast('Setup j√° existe','error');return}
    D.setups.push(name);
    save();updateSetupSelect();updateSetupList();
    input.value='';toast('‚úÖ Setup adicionado!');
}
function removeSetup(i){
    if(confirm('Remover setup "'+D.setups[i]+'"?')){
        D.setups.splice(i,1);
        save();updateSetupSelect();updateSetupList();
        toast('Setup removido!');
    }
}
function addQual(){
    const input=document.getElementById('newQual');
    const name=input.value.trim();
    if(!name){toast('Digite o nome da qualidade','error');return}
    if(D.qualidades.includes(name)){toast('Qualidade j√° existe','error');return}
    D.qualidades.push(name);
    save();updateQualSelect();updateQualList();
    input.value='';toast('‚úÖ Qualidade adicionada!');
}
function removeQual(i){
    if(confirm('Remover qualidade "'+D.qualidades[i]+'"?')){
        D.qualidades.splice(i,1);
        save();updateQualSelect();updateQualList();
        toast('Qualidade removida!');
    }
}

// Fun√ß√£o de editar opera√ß√£o
function editTrade(id){
    const t=D.trades.find(x=>x.id===id);
    if(!t)return;
    document.getElementById('tDate').value=t.date;
    document.getElementById('tTime').value=t.time||'';
    document.getElementById('tAsset').value=t.asset;
    document.getElementById('tDir').value=t.dir;
    document.getElementById('tCts').value=t.cts;
    document.getElementById('tEntry').value=t.entry||'';
    document.getElementById('tExit').value=t.exit||'';
    document.getElementById('tResult').value=t.result;
    document.getElementById('tSetup').value=t.setup||'';
    document.getElementById('tQual').value=t.qual||D.qualidades[0]||'';
    // Remove a opera√ß√£o antiga
    D.trades=D.trades.filter(x=>x.id!==id);
    save();update();
    document.querySelector('[data-tab="trades"]').click();
    toast('Editando opera√ß√£o - fa√ßa as altera√ß√µes e salve');
}

// Fun√ß√µes de Imposto
function updateImposto(){
    if(!D.impostos)D.impostos={};
    const meses={};
    // Agrupa trades por m√™s
    D.trades.forEach(t=>{
        const d=new Date(t.date+'T12:00:00');
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        if(!meses[key])meses[key]={lucro:0,prejuizo:0};
        if(t.result>0)meses[key].lucro+=t.result;
        else meses[key].prejuizo+=Math.abs(t.result);
    });
    
    // Calcula imposto por m√™s
    const hoje=new Date();
    const mesAtual=`${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
    const anoAtual=hoje.getFullYear();
    let impostoMesAtual=0,totalPagoAno=0,totalPendente=0;
    
    // Gera tabela
    const tbody=document.getElementById('impostoBody');
    if(!tbody)return;
    tbody.innerHTML='';
    
    // Calcula todos os impostos primeiro
    const dadosMeses=[];
    Object.keys(meses).forEach(key=>{
        const m=meses[key];
        const liquido=m.lucro-m.prejuizo;
        const imposto=liquido>0?liquido*0.2:0;
        const pago=D.impostos[key]?.pago||false;
        const [ano,mes]=key.split('-');
        dadosMeses.push({key,liquido,imposto,pago,ano:parseInt(ano),mes:parseInt(mes)});
    });
    
    // Ordena por data decrescente
    dadosMeses.sort((a,b)=>b.key.localeCompare(a.key));
    
    // Calcula totais
    dadosMeses.forEach(d=>{
        if(d.key===mesAtual){
            impostoMesAtual=d.imposto;
        }
        
        // Total pago no ano atual
        if(d.ano===anoAtual && d.pago && d.imposto>0){
            totalPagoAno+=d.imposto;
        }
        
        // Pendente = qualquer m√™s anterior com imposto > 0 e n√£o pago
        if(d.key!==mesAtual && d.imposto>0 && !d.pago){
            totalPendente+=d.imposto;
        }
    });
    
    // Gera tabela
    dadosMeses.forEach(d=>{
        const nomeMes=new Date(d.ano,d.mes-1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
        tbody.innerHTML+=`
            <tr>
                <td>${nomeMes.charAt(0).toUpperCase()+nomeMes.slice(1)}</td>
                <td class="${d.liquido>=0?'pos':'neg'}">${fmt(d.liquido)}</td>
                <td>${fmt(d.imposto)}</td>
                <td><span class="${d.pago?'imposto-pago':'imposto-pendente'}">${d.pago?'‚úÖ Pago':'‚è≥ Pendente'}</span></td>
                <td>${d.imposto>0?`<button class="btn btn-s" onclick="togglePago('${d.key}')">${d.pago?'Desfazer':'Marcar Pago'}</button>`:'-'}</td>
            </tr>
        `;
    });
    
    // Atualiza displays
    const mesAtualNome=new Date(hoje.getFullYear(),hoje.getMonth()).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
    document.getElementById('impostoMes').textContent=fmt(impostoMesAtual);
    document.getElementById('impostoMesRef').textContent=mesAtualNome.charAt(0).toUpperCase()+mesAtualNome.slice(1);
    document.getElementById('impostoPagoAno').textContent=fmt(totalPagoAno);
    document.getElementById('impostoAnoRef').textContent='Ano '+anoAtual;
    document.getElementById('impostoPendente').textContent=fmt(totalPendente);
    
    // Salva dados para Dashboard
    window.impostoData={mesAtual:impostoMesAtual,pendente:totalPendente};
    updateDashboardImposto();
}

function updateDashboardImposto(){
    const data=window.impostoData||{mesAtual:0,pendente:0};
    const el=document.getElementById('impostoCard');
    const alertEl=document.getElementById('impostoPendenteAlert');
    
    if(el){
        document.getElementById('impostoDash').textContent=fmt(data.mesAtual);
    }
    
    if(alertEl){
        if(data.pendente>0){
            alertEl.style.display='flex';
            document.getElementById('impostoPendenteValor').textContent=fmt(data.pendente);
        }else{
            alertEl.style.display='none';
        }
    }
}

function togglePago(key){
    if(!D.impostos[key])D.impostos[key]={};
    D.impostos[key].pago=!D.impostos[key].pago;
    save();updateImposto();
    toast(D.impostos[key].pago?'‚úÖ Marcado como pago!':'Desmarcado');
}
</script>
</body>
</html>
